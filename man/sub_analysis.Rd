% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/yyds_sub_analysis.R
\name{sub_analysis}
\alias{sub_analysis}
\title{分层回归分析与森林图绘制}
\usage{
sub_analysis(
  data,
  time = NULL,
  family_type = NULL,
  status,
  exposure,
  adjust_vars,
  stratify_vars,
  ref = FALSE,
  plot_type = 1,
  plot_column = NULL,
  xlim = NULL,
  ticks_at = NULL
)
}
\arguments{
\item{data}{数据框（data.frame），包含所有分析所需变量。}

\item{time}{生存分析中的随访时间变量。若进行 Cox 回归必须提供。}

\item{family_type}{回归模型族类。支持 "binomial"（二项）、"poisson"（泊松）、"gaussian"（高斯）。若为生存分析则设为 NULL。}

\item{status}{状态变量，用于表示事件是否发生（0/1）。}

\item{exposure}{暴露变量，可以是分类变量或连续变量。}

\item{adjust_vars}{向模型中加入的协变量（字符串向量）。}

\item{stratify_vars}{用于分层分析的变量（字符串向量）。}

\item{ref}{是否展示ref组在森林图中。默认为 TRUE。}

\item{plot_type}{图类型 c(1,2,3)。}

\item{plot_column}{用于绘图的列索引，可自选展示列和排序。}

\item{xlim}{X轴范围，用于控制森林图的显示范围。}

\item{ticks_at}{X轴刻度点，用于控制森林图的坐标刻度。}
}
\value{
返回一个包含以下组成部分的列表：
\itemize{
\item 格式化后的回归结果汇总表。
\item 森林图对象（ggplot/forestploter 生成）。
}
}
\description{
\itemize{
\item 该函数用于进行亚组分析并绘制森林图，支持Cox比例风险模型。
\item 支持Cox比例风险模型、逻辑回归、泊松回归和线性回归。
}
}
\details{
\itemize{
\item 若指定 \code{time}，则进行 Cox 生存分析。
\item 若指定 \code{family_type}，则按指定族类进行广义线性模型分析。
\item \code{time}和\code{family_type}不能同时出现。
\item 交互作用P值计算使用 \code{yyds_pforinteraction()} 函数。
}
}
\examples{
# 加载必要的包
library(survival)
library(dplyr)
library(forestploter)

# 创建随机生存数据
set.seed(123)
n <- 500
survival_data <- data.frame(
  id = 1:n,
  #' 治疗组(0=对照组, 1=治疗组)
  treatment = sample(c(0,1), n, replace = TRUE),
  #' 年龄(20-80岁)
  age = round(runif(n, 20, 80)),
  #' 性别(0=女, 1=男)
  sex = sample(c(0,1), n, replace = TRUE),
  #' 疾病分期(I,II,III)
  stage = sample(c("I","II","III"), n, replace = TRUE, prob = c(0.3,0.4,0.3)),
  #' 肿瘤部位(A,B)
  site = sample(c("A","B"), n, replace = TRUE),
  #' 生存时间(1-60个月)
  time = round(runif(n, 1, 60)),
  #' 事件状态(0=删失, 1=事件)
  status = sample(c(0,1), n, replace = TRUE, prob = c(0.2,0.8))
)

# 将分类变量转为因子
survival_data$treatment <- factor(survival_data$treatment, levels = c(0,1), labels = c("Control", "Treatment"))
survival_data$sex <- factor(survival_data$sex, levels = c(0,1), labels = c("Female", "Male"))
survival_data$stage <- factor(survival_data$stage, levels = c("I","II","III"))
survival_data$site <- factor(survival_data$site)
#' 进行亚组分析
result_cox <- sub_analysis(
  data = survival_data,
  time = "time",
  status = "status",
  exposure = "treatment",
  adjust_vars = c("age", "sex"),
  stratify_vars = c( "site"),
  ref = FALSE,
  plot_type = 2,
  xlim = c(0.1, 10),
  ticks_at = c(0.1, 1, 5, 10)
)

# 查看结果表格
head(result_cox)

##
set.seed(123)
n <- 400
bina_data <- data.frame(
  id = 1:n,
  #' 治疗组(0=对照组, 1=治疗组)
  treatment = sample(c(0,1), n, replace = TRUE),
  #' 年龄(20-80岁)
  age = round(runif(n, 20, 80)),
  #' 性别(0=女, 1=男)
  sex = sample(c(0,1), n, replace = TRUE),
  #' 疾病严重程度(轻,中,重)
  severity = sample(c("Mild","Moderate","Severe"), n, replace = TRUE, prob = c(0.4,0.4,0.2)),
  #' 并发症(无,有)
  complication = sample(c("No","Yes"), n, replace = TRUE),
  #' 治疗结果(0=失败, 1=成功)
  outcome = sample(c(0,1), n, replace = TRUE, prob = c(0.3,0.7))
)

# 将分类变量转为因子
bina_data$treatment <- factor(bina_data$treatment, levels = c(0,1), labels = c("Placebo", "Active"))
bina_data$sex <- factor(bina_data$sex, levels = c(0,1), labels = c("Female", "Male"))
bina_data$severity <- factor(bina_data$severity, levels = c("Mild","Moderate","Severe"))
bina_data$complication <- factor(bina_data$complication)

# 进行亚组分析
result_logistic <- sub_analysis(
  data = bina_data,
  family_type = "binomial",
  status = "outcome",
  exposure = "treatment",
  adjust_vars = c("age", "sex"),
  stratify_vars = c("severity", "complication"),
  ref = TRUE,
  plot_type = 3,
  xlim = c(0.1, 20),
  ticks_at = c(0.1, 1, 5, 10, 20)
)

# 查看结果表格
head(result_logistic)

}

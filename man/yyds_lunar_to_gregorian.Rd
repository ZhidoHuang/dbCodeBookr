% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/yyds_lunar_to_gregorian.R
\name{yyds_lunar_to_gregorian}
\alias{yyds_lunar_to_gregorian}
\title{批量将农历日期转换为公历日期（支持行筛选与并行）}
\usage{
yyds_lunar_to_gregorian(
  df,
  y_col = "ba002_1",
  m_col = "ba002_2",
  d_col = "ba002_3",
  out_col = "birth_gregorian",
  row_filter = NULL,
  ignore_leap = TRUE,
  workers = 6,
  chunk_size = NULL,
  chunks_per_worker = 24L,
  load_balance = TRUE
)
}
\arguments{
\item{df}{要处理的数据框（data.frame 或可转换为 data.table）。}

\item{y_col}{农历“年”列名，默认为 \code{"ba002_1"}。}

\item{m_col}{农历“月”列名，默认为 \code{"ba002_2"}。}

\item{d_col}{农历“日”列名，默认为 \code{"ba002_3"}。}

\item{out_col}{输出的公历日期列名，默认为 \code{"birth_gregorian"}；
若列不存在将自动创建，未被筛选的行保持为 NA。}

\item{row_filter}{行筛选条件，用于指定哪些行需要进行转换。
支持以下形式：
\itemize{
\item \code{NULL}：处理全部行；
\item \code{logical} 向量：长度必须等于 \code{nrow(df)}，NA 将视为 FALSE；
\item \code{expression / quote()}：在 data.table 环境中求值；
\item \code{character}：可解析的单行表达式字符串（如 \code{'ba003 == "Lunar calendar"'}）。
}}

\item{ignore_leap}{是否忽略农历闰月，传递给 \code{hongkong::lunarCal()}，
默认为 TRUE。}

\item{workers}{并行计算使用的进程数，默认为 6；
设为 1 时使用串行计算。}

\item{chunk_size}{每个并行任务中包含的“唯一日期”数量；
若为 NULL，则根据 \code{chunks_per_worker} 自动估算。}

\item{chunks_per_worker}{自动分块时，每个 worker 的目标 chunk 数，
默认为 24。}

\item{load_balance}{是否使用动态负载均衡；
TRUE 使用 \code{parLapplyLB()}，FALSE 使用 \code{parLapply()}。}
}
\value{
返回一个 list，包含：
\itemize{
\item \code{data}：写入公历日期后的数据框；
\item \code{bad_unique}：转换失败的唯一农历日期（字符向量，格式 \code{"YYYY-MM-DD"}）。
}
}
\description{
使用 hongkong::lunarCal 批量转换 CHARLS 农历出生日期为公历日期。
根据农历年、月、日变量及行筛选条件，对指定样本生成公历出生日期。
}
\details{
函数执行流程如下：
\enumerate{
\item 根据 \code{row_filter} 生成严格的行索引（NA 视为 FALSE）；
\item 仅对被筛选且年/月/日完整的行提取唯一农历日期组合；
\item 对唯一日期进行农历→公历转换（支持并行）；
\item 将结果映射回原始行，仅写回被筛选的行；
\item 自动统计缺失情况与转换失败情况，并打印摘要信息。
}

统计输出中：
\itemize{
\item \strong{Rows processed}：满足 row_filter 的行数；
\item \strong{Missing(y/m/d any NA)}：被筛选行中年/月/日任一缺失的行数；
\item \strong{Error Lunar dates}：年/月/日完整但转换失败的行数（按行计）；
\item \strong{Unique error dates}：转换失败的唯一农历日期数量。
}

函数默认启用计时功能，执行结束时会自动输出总耗时。
}
\examples{
\dontrun{
# expression / quote（推荐）
res <- yyds_lunar_to_gregorian(
  data,
  y_col   = "ba002_1",
  m_col   = "ba002_2",
  d_col   = "ba002_3",
  out_col = "birth_gregorian",
  row_filter = quote(ba003 == "Lunar calendar")
)

# 字符串形式（不要写 data$）
res <- yyds_lunar_to_gregorian(
  data,
  y_col   = "ba002_1",
  m_col   = "ba002_2",
  d_col   = "ba002_3",
  out_col = "birth_gregorian",
  row_filter = 'ba003 == "Lunar calendar"'
)

# 逻辑向量（NA 自动视为 FALSE）
res <- yyds_lunar_to_gregorian(
  data,
  y_col   = "ba002_1",
  m_col   = "ba002_2",
  d_col   = "ba002_3",
  out_col = "birth_gregorian",
  row_filter = data$ba003 == "Lunar calendar"
)
}

}
